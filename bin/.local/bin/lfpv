#!/bin/sh

mkdir --parents -- "$LF_CACHE_DIR"

case "$(file --brief --mime-type -- "$1")" in
	"text/"*) cat -- "$1" ;;
	"image/"* | "audio/"* | "video/"*)
		thumbnail="$LF_CACHE_DIR/$(printf -- "%s:%s.png" "$1" "$(stat --format="%Y" "$1")" | shasum | head --bytes="40")"
		[ ! -f "$thumbnail" ] && { ffmpeg -i "$1" -frames:v "1" -filter:v "scale=512:-1" -- "$thumbnail" || exec mediainfo "$1" ;}

		printf -- "{ \"action\": \"add\", \"identifier\": \"PREVIEW\", \"scaler\": \"contain\", \"path\": \"%s\", \"width\": \"%d\", \"height\": \"%d\", \"x\": \"$(($4 + 1))\", \"y\": \"$5\" }" "$thumbnail" "$(($2 - 2))" "$3" > "$FIFO_UEBERZUG"
		exit "1"
		;;
	*) mediainfo -- "$1" ;;
esac
