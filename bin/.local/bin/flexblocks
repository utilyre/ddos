#!/bin/sh

desktops() {
	while read -r line; do
		self="$(bspc query --desktops --desktop --names)"
		nodes="$(bspc query --desktop "$line" --nodes --node ".window")"
		[ "$line" != "$self" ] && [ -z "$nodes" ] && continue

		printf -- "%%{A:bspc desktop --focus \"%s\":}" "$line"
		[ "$line" = "$self" ] && printf -- "%%{+u}"
		printf -- " %s " "$line"
		[ "$line" = "$self" ] && printf -- "%%{-u}"
		printf -- "%%{A}"
	done <<- EOF
		$(bspc query --desktops --names)
	EOF
}

clock() {
	date -- "+%H:%M %a, %b %d"
}

temperature() {
	printf -- " %d°C" "$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_input")"
}

memory() {
	free --human | awk -- "(\$1 == \"Mem:\") { print \" \" \$4 }"
}

volume() {
	printf -- " %s  %s" \
		"$(voltage --device="sink" get)" \
		"$(voltage --device="source" get)"
}

connection() {
	status="Down"
	download="0B/s"
	upload="0B/s"

	grep --quiet -- "up" "/sys/class/net"/w*/"operstate" && {
		status=" $(awk -- "(NR == 3) { print int(\$3) }" "/proc/net/wireless")%"
		download="$(tradiff "/sys/class/net/"w*"/statistics/rx_bytes")/s"
		upload="$(tradiff "/sys/class/net/"w*"/statistics/tx_bytes")/s"
	}

	grep --quiet -- "up" "/sys/class/net"/e*/"operstate" && {
		status=""
		download="$(tradiff "/sys/class/net"/e*/"statistics/rx_bytes")/s"
		upload="$(tradiff "/sys/class/net"/e*/"statistics/tx_bytes")/s"
	}

	printf -- "%s  %s  %s\n" "$status" "$download" "$upload"
}

trap -- "unset desktops" "USR1"
trap -- "unset volume" "USR2"
while true; do
	sleep -- "1s" & wait -- "$!"
	timestamp="$(date -- "+%s")"

	[ -z "$desktops" ] && desktops="$(desktops)"
	[ -z "$clock" ] || [ "$(($timestamp % 60))" -eq "0" ] && clock="$(clock)"

	[ -z "$temperature" ] || [ "$(($timestamp % 10))" -eq "0" ] && temperature="$(temperature)"
	[ -z "$memory" ] || [ "$(($timestamp % 30))" -eq "0" ] && memory="$(memory)"
	[ -z "$volume" ] || [ "$(($timestamp % 5))" -eq "0" ] && volume="$(volume)"
	[ -z "$connection" ] || [ "$(($timestamp % 1))" -eq "0" ] && connection="$(connection)"

	printf -- "%s %s %s \n" \
		"%{l}    $desktops" \
		"%{c}  $clock" \
		"%{r}  $connection  $volume  $memory  $temperature %{A:xenon:}  %{A} "
done
