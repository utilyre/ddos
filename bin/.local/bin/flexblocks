#!/bin/sh

desktops() {
	while read -r line; do
		self="$(bspc query --desktops --desktop --names)"
		nodes="$(bspc query --desktop "$line" --nodes --node ".window")"
		[ "$line" != "$self" ] && [ -z "$nodes" ] && continue

		printf -- "%%{A:bspc desktop --focus \"%s\":}" "$line"
		[ "$line" = "$self" ] && printf -- "%%{+u}"
		printf -- " %s " "$line"
		[ "$line" = "$self" ] && printf -- "%%{-u}"
		printf -- "%%{A}"
	done <<- EOF
		$(bspc query --desktops --names)
	EOF
}

clock() {
	date -- "+%H:%M %a, %b %d"
}

traffic() {
	printf -- " %s/s  %s/s\n" \
		"$(find "/sys/class/net/" -type "l" -name "[ew]*" -printf "%p/statistics/rx_bytes\0" | xargs --null -- tradiff)" \
		"$(find "/sys/class/net/" -type "l" -name "[ew]*" -printf "%p/statistics/tx_bytes\0" | xargs --null -- tradiff)"
}

connection() {
	find "/sys/class/net/" -type "l" -name "e*" -printf "%p/operstate\0" | xargs --null -- grep --quiet -- "up" && {
		printf -- "\n"
		return
	}

	find "/sys/class/net" -type "l" -name "w*" -printf "%p/operstate\0" | xargs --null -- grep --quiet -- "up" && {
		printf -- " %s (%s%%)\n" \
			"$(nmcli --terse --fields "NAME" connection show | head --lines="1")" \
			"$(awk -- "(NR == 3) { print int(\$3) }" "/proc/net/wireless")"
		return
	}

	printf -- "\n"
}

volume() {
	voltage --device="sink" get > "/dev/null" &&
		printf -- " %s " "$(voltage --device="sink" get)" ||
		printf -- " "

	voltage --device="source" get > "/dev/null" &&
		printf -- " %s\n" "$(voltage --device="source" get)" ||
		printf -- "\n"
}

battery() {
	supply="$(find "/sys/class/power_supply/" -type "l" -name "BAT*" -quit -printf "%p\0")"
	[ -z "$supply" ] && {
		printf -- "\n"
		return
	}

	printf -- " %s (%s%%)\n" \
		"$(cat -- "$supply/status")" \
		"$(cat -- "$supply/capacity")"
}

system() {
	printf -- " %s  %s°C\n" \
		"$(free --human | awk -- "(\$1 == \"Mem:\") { print \$4 }")" \
		"$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_input")"
}

trap -- "unset desktops" "USR1"
trap -- "unset volume" "USR2"
while true; do
	sleep -- "1s" & wait -- "$!"
	timestamp="$(date -- "+%s")"

	[ -z "$desktops" ] && desktops="$(desktops)"
	[ -z "$clock" ] || [ "$(($timestamp % 60))" -eq "0" ] && clock="$(clock)"
	[ -z "$traffic" ] || [ "$(($timestamp % 1))" -eq "0" ] && traffic="$(traffic)"
	[ -z "$connection" ] || [ "$(($timestamp % 15))" -eq "0" ] && connection="$(connection)"
	[ -z "$volume" ] || [ "$(($timestamp % 5))" -eq "0" ] && volume="$(volume)"
	[ -z "$battery" ] || [ "$(($timestamp % 30))" -eq "0" ] && battery="$(battery)"
	[ -z "$system" ] || [ "$(($timestamp % 10))" -eq "0" ] && system="$(system)"

	printf -- "%%{l} %s %%{c} %s %%{r} %s \n" \
		"$desktops" \
		"$clock" \
		"$traffic    $connection    $volume    $battery    $system                "
done
