#!/bin/sh

date_color="$(xrdb -get "fblk.date")"
wttr_color="$(xrdb -get "fblk.wttr")"
uptm_color="$(xrdb -get "fblk.uptm")"
desk_color="$(xrdb -get "fblk.desk")"
volt_color="$(xrdb -get "fblk.volt")"
memo_color="$(xrdb -get "fblk.memo")"
temp_color="$(xrdb -get "fblk.temp")"

m_date() {
	date "+%H:%M %a, %b %d"
}

m_wttr() {
	curl "https://wttr.in/Hamadan?m&format=%l,+%C+%t"
}

m_uptm() {
	uptime --pretty | sed --regexp-extended "s/^(.)/\U\1/"
}

m_desk() {
	desk_current="$(bspc query --desktops --desktop --names)"

	while read -r line; do
		[ "$line" = "$desk_current" ] &&
			printf "%s" "%{F:{current}}%{U:{current}}%{+u} $line %{-u}%{U-}%{F-}" ||
			printf "%s" "%{A:bspc desktop --focus \"$line\":} $line %{A}"
	done <<- EOF
		$(bspc query --desktops --names)
	EOF

	unset desk_current
}

m_volt() {
	printf "%s <> %s" \
		"$(volt --device="sink" get)" \
		"$(volt --device="source" get)"
}

m_memo() {
	free --human | awk "(\$0 ~ /^Mem:/) { print \$3 \"/\" \$2 }"
}

m_temp() {
	printf "%s°C (High: %s°C)" \
		"$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_input")" \
		"$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_max")"
}

trap "unset desk" "10"
trap "unset volt" "12"
while true; do
	sleep "1s" & wait "$!"
	timestamp="$(date "+%s")"

	[ -z "$date" ] || [ "$(($timestamp % 60))" -eq "0" ] && date="$(m_date)"
	[ -z "$wttr" ] || [ "$(($timestamp % 1800))" -eq "0" ] && wttr="$(m_wttr)"
	[ -z "$uptm" ] || [ "$(($timestamp % 60))" -eq "0" ] && uptm="$(m_uptm)"

	[ -z "$desk" ] && desk="$(m_desk)"

	[ -z "$volt" ] && volt="$(m_volt)"
	[ -z "$memo" ] || [ "$(($timestamp % 30))" -eq "0" ] && memo="$(m_memo)"
	[ -z "$temp" ] || [ "$(($timestamp % 10))" -eq "0" ] && temp="$(m_temp)"

	printf "%s%s%s\n" \
		"%{l} %{F$date_color}%{U$date_color}%{+u}  $date %{-u}%{U-}%{F-} %{F$wttr_color}%{U$wttr_color}%{+u}  $wttr %{-u}%{U-}%{F-} %{F$uptm_color}%{U$uptm_color}%{+u}  $uptm %{-u}%{U-}%{F-} " \
		"%{c} $(echo "$desk" | sed "s/:{current}/$desk_color/g") " \
		"%{r} %{F$volt_color}%{U$volt_color}%{+u}  $volt %{-u}%{U-}%{F-} %{F$memo_color}%{U$memo_color}%{+u}  $memo %{-u}%{U-}%{F-} %{F$temp_color}%{U$temp_color}%{+u}  $temp %{-u}%{U-}%{F-} "
done
