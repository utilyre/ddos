#!/bin/sh

date_color="$(xrdb -get "fblk.date")"
wttr_color="$(xrdb -get "fblk.wttr")"
mail_color="$(xrdb -get "fblk.mail")"
boat_color="$(xrdb -get "fblk.boat")"
desk_color="$(xrdb -get "fblk.desk")"
temp_color="$(xrdb -get "fblk.temp")"
memo_color="$(xrdb -get "fblk.memo")"
volt_color="$(xrdb -get "fblk.volt")"
conn_color="$(xrdb -get "fblk.conn")"

_date() {
	date -- "+%H:%M %a, %b %d"
}

_wttr() {
	curl -- "https://wttr.in/Hamadan?m&format=%l,+%C+%t"
}

_mail() {
	printf -- "%d" "1"
}

_boat() {
	boat --execute="print-unread" | cut --delimiter=" " --fields="1"
}

_desk() {
	while read -r line; do
		printf -- "%%{A:bspc desktop --focus \"%s\":}" "$line"
		[ -n "$(bspc query --desktop "$line" --nodes --node ".window")" ] && printf -- "%%{F:current}"
		[ "$line" = "$(bspc query --desktops --desktop --names)" ] && printf -- "%%{U:current}%%{+u}"

		printf -- " %s " "$line"

		[ "$line" = "$(bspc query --desktops --desktop --names)" ] && printf -- "%%{-u}%%{U-}"
		[ -n "$(bspc query --desktop "$line" --nodes --node ".window")" ] && printf -- "%%{F-}"
		printf -- "%%{A}"
	done <<- EOF
		$(bspc query --desktops --names)
	EOF
}

_temp() {
	printf -- "%d°C" "$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_input")"
}

_memo() {
	free --human | awk -- "(\$1 == \"Mem:\") { print \$4 }"
}

_volt() {
	printf -- "%s <> %s" \
		"$(volt --device="sink" get)" \
		"$(volt --device="source" get)"
}

_conn() {
	printf -- "Ethernet: "
	grep --quiet "up" -- "/sys/class/net"/e*/"operstate" &&
		printf -- "Up" ||
		printf -- "Down"

	printf -- " <> "

	printf -- "Wi-Fi: "
	grep --quiet "up" -- "/sys/class/net"/w*/"operstate" &&
		printf -- "%s%%" "$(awk -- "(NR == 3) { print int(\$3) }" "/proc/net/wireless")" ||
		printf -- "Down"
}

trap "unset desk" "10"
trap "unset volt" "12"
while true; do
	sleep -- "1s" & wait -- "$!"
	timestamp="$(date -- "+%s")"

	[ -z "$date" ] || [ "$(($timestamp % 0060))" -eq "0" ] && date="$(_date)"
	[ -z "$wttr" ] || [ "$(($timestamp % 1800))" -eq "0" ] && wttr="$(_wttr)"
	[ -z "$mail" ] || [ "$(($timestamp % 0010))" -eq "0" ] && mail="$(_mail)"
	[ -z "$boat" ] || [ "$(($timestamp % 0010))" -eq "0" ] && boat="$(_boat)"

	[ -z "$desk" ]                                         && desk="$(_desk)"

	[ -z "$temp" ] || [ "$(($timestamp % 0010))" -eq "0" ] && temp="$(_temp)"
	[ -z "$memo" ] || [ "$(($timestamp % 0010))" -eq "0" ] && memo="$(_memo)"
	[ -z "$volt" ]                                         && volt="$(_volt)"
	[ -z "$conn" ] || [ "$(($timestamp % 0010))" -eq "0" ] && conn="$(_conn)"

	printf -- "%s %s %s \n" \
		"%{l} %{F$date_color}%{U$date_color}%{+u}  $date %{-u}%{U-}%{F-} %{F$wttr_color}%{U$wttr_color}%{+u}  $wttr %{-u}%{U-}%{F-} %{F$mail_color}%{U$mail_color}%{+u}  $mail %{-u}%{U-}%{F-} %{F$boat_color}%{U$boat_color}%{+u}  $boat %{-u}%{U-}%{F-}" \
		"%{c} $(printf -- "%s" "$desk" | sed -- "s/:current/$desk_color/g")" \
		"%{r} %{F$temp_color}%{U$temp_color}%{+u}  $temp %{-u}%{U-}%{F-} %{F$memo_color}%{U$memo_color}%{+u}  $memo %{-u}%{U-}%{F-} %{F$volt_color}%{U$volt_color}%{+u}  $volt %{-u}%{U-}%{F-} %{F$conn_color}%{U$conn_color}%{+u}  $conn %{-u}%{U-}%{F-}"
done
