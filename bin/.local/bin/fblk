#!/bin/sh

date_color="$(xrdb -get "fblk.date")"
wttr_color="$(xrdb -get "fblk.wttr")"
uptm_color="$(xrdb -get "fblk.uptm")"
desk_color="$(xrdb -get "fblk.desk")"
volt_color="$(xrdb -get "fblk.volt")"
memo_color="$(xrdb -get "fblk.memo")"
temp_color="$(xrdb -get "fblk.temp")"

_date() {
	date -- "+%H:%M %a, %b %d"
}

_wttr() {
	curl -- "https://wttr.in/Hamadan?m&format=%l,+%C+%t"
}

_uptm() {
	uptime --pretty | sed --regexp-extended -- "s/^(.)/\U\1/"
}

_desk() {
	while read -r line; do
		printf -- "%{A:bspc desktop --focus \"%s\":}" "$line"
		[ -n "$(bspc query --desktop "$line" --nodes --node ".window")" ] && printf -- "%{F:current}"
		[ "$line" = "$(bspc query --desktops --desktop --names)" ] && printf -- "%{U:current}%{+u}"

		printf -- " %s " "$line"

		[ "$line" = "$(bspc query --desktops --desktop --names)" ] && printf -- "%{-u}%{U-}"
		[ -n "$(bspc query --desktop "$line" --nodes --node ".window")" ] && printf -- "%{F-}"
		printf -- "%{A}"
	done <<- EOF
		$(bspc query --desktops --names)
	EOF
}

_volt() {
	printf -- "%s <> %s" \
		"$(volt --device="sink" get)" \
		"$(volt --device="source" get)"
}

_memo() {
	free --human | awk -- "(\$0 ~ /^Mem:/) { print \$3 \"/\" \$2 }"
}

_temp() {
	printf -- "%d°C (High: %d°C)" \
		"$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_input")" \
		"$(sensors -j | jq --raw-output ".\"coretemp-isa-0000\".\"Package id 0\".temp1_max")"
}

trap "unset desk" "10"
trap "unset volt" "12"
while true; do
	sleep -- "1s" & wait -- "$!"
	timestamp="$(date -- "+%s")"

	[ -z "$date" ] || [ "$(($timestamp % 60))" -eq "0" ] && date="$(_date)"
	[ -z "$wttr" ] || [ "$(($timestamp % 1800))" -eq "0" ] && wttr="$(_wttr)"
	[ -z "$uptm" ] || [ "$(($timestamp % 60))" -eq "0" ] && uptm="$(_uptm)"

	[ -z "$desk" ] && desk="$(_desk)"

	[ -z "$volt" ] && volt="$(_volt)"
	[ -z "$memo" ] || [ "$(($timestamp % 30))" -eq "0" ] && memo="$(_memo)"
	[ -z "$temp" ] || [ "$(($timestamp % 10))" -eq "0" ] && temp="$(_temp)"

	printf -- "%s %s %s\n" \
		"%{l} %{F$date_color}%{U$date_color}%{+u}  $date %{-u}%{U-}%{F-} %{F$wttr_color}%{U$wttr_color}%{+u}  $wttr %{-u}%{U-}%{F-} %{F$uptm_color}%{U$uptm_color}%{+u}  $uptm %{-u}%{U-}%{F-}" \
		"%{c} $(printf -- "%s" "$desk" | sed -- "s/:current/$desk_color/g")" \
		"%{r} %{F$volt_color}%{U$volt_color}%{+u}  $volt %{-u}%{U-}%{F-} %{F$memo_color}%{U$memo_color}%{+u}  $memo %{-u}%{U-}%{F-} %{F$temp_color}%{U$temp_color}%{+u}  $temp %{-u}%{U-}%{F-}"
done
